<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TCGP Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {--bg:#f3f5f7;--card-bg:#fff;--primary:#1976d2;--text:#333;--accent:#4caf50;--radius:8px;}
    *{box-sizing:border-box;margin:0;padding:0;}
    body{background:var(--bg);color:var(--text);font-family:sans-serif;padding:1rem;}
    .box{max-width:480px;margin:auto;background:var(--card-bg);padding:1rem;border-radius:var(--radius);box-shadow:0 2px 8px rgba(0,0,0,0.1);}
    h1{text-align:center;color:var(--primary);margin-bottom:1rem;}
    .controls{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;}
    input[type=number]{width:3rem;padding:0.2rem;border:1px solid #ccc;border-radius:var(--radius);text-align:center;}
    button{padding:0.4rem 0.8rem;background:var(--primary);color:#fff;border:none;border-radius:var(--radius);cursor:pointer;}
    .stats{font-size:0.9rem;margin:1rem 0;}
    .barWrap{background:#e0e0e0;border-radius:var(--radius);overflow:hidden;height:12px;margin-bottom:1rem;}
    .bar{background:var(--accent);height:12px;width:0%;}
    canvas{width:100%!important;height:150px!important;margin-bottom:1rem;}
    hr{border:none;border-top:1px solid #eee;margin:1rem 0;}
    .set{margin-top:1rem;font-weight:bold;color:var(--primary);border-bottom:1px solid #ddd;padding-bottom:0.2rem;}
    .card{display:flex;align-items:center;padding:0.3rem 0;}
    .card input{margin-right:0.5rem;width:1rem;height:1rem;}
  </style>
</head>
<body>
  <div class="box">
    <h1>TCGP Tracker</h1>
    <div class="controls">
      <label>Buste al giorno: <input type="number" id="packs" min="2" max="4" step="1" value="3"></label>
      <button id="resetBtn">Azzera</button>
    </div>
    <div id="counts" class="stats"></div>
    <div id="pattern" class="stats"></div>
    <div class="barWrap"><div id="progressBar" class="bar"></div></div>
    <canvas id="chartCanvas"></canvas>
    <div id="simStats" class="stats"></div>
    <hr>
    <div id="list"></div>
  </div>
<script>
const cards=[["Solgaleo","Trevenent",2],["Solgaleo","Tapu Bulu",3],["Solgaleo","Talonflame",3],["Solgaleo","Incineroar ex",4],["Solgaleo","Sandlash",2],["Solgaleo","Cloyster",2],["Solgaleo","Crabominable ex",4],["Solgaleo","Oricorio",3],["Solgaleo","Tapu Koko",3],["Solgaleo","Sandygast",1],["Solgaleo","Palossand",3],["Solgaleo","Crabrawler",1],["Solgaleo","Klefki",3],["Solgaleo","Magearna",3],["Solgaleo","Drampa",3],["Solgaleo","Hawlucha",2],["Solgaleo","Komala",2],["Lunala","Exeggcute",1],["Lunala","Decidueye ex",4],["Lunala","Morelull",1],["Lunala","Litten",1],["Lunala","Sandlash",2],["Lunala","Ninetales",3],["Lunala","Popplio",1],["Lunala","Brionne",2],["Lunala","Primarina",3],["Lunala","Oricorio-N",2],["Lunala","Tapu Lele",3],["Lunala","Necrozma",3],["Lunala","Conkeldurr",3],["Lunala","Lycanroc",3],["Lunala","Raticate",2],["Lunala","Kommo-o",3],["Lunala","Oranguru",3],["Lunala","Oricorio-S",2]];
const pR={1:0.06664397,2:0.04365052,3:0.00917221,4:0.01661559};
const ST="tcgpFound_pattern";
let found=JSON.parse(localStorage.getItem(ST)||"{}"),chart;

function saveState(){localStorage.setItem(ST,JSON.stringify(found));}
function monteCarlo(sol,lun,packs,sims=500){
  const rar=[1,2,3,4],pat=['L','L','S'];
  function run(){let s=sol,l=lun,d=0,i=0;while(s>0||l>0){d++;for(let k=0;k<packs;k++){const set=l>0?pat[i++%3]:'S',r=rar[Math.floor(Math.random()*4)];if(Math.random()<pR[r]){if(set==='L'&&l>0)l--;else if(set==='S'&&s>0)s--;}}}return d;}
  const arr=Array.from({length:sims},run).sort((a,b)=>a-b);
  return [0.5,0.75,0.9,0.99].map(p=>arr[Math.floor(arr.length*p)-1]);
}
function renderList(){
  const con=document.getElementById("list");let html="";
  ["Lunala","Solgaleo"].forEach(set=>{html+=`<div class="set">${set}</div>`;cards.filter(c=>c[0]===set).forEach((c,i)=>{const id=`${set}_${i}`,chk=found[id]?"checked":"";html+=`<div class="card"><input type="checkbox" id="${id}" ${chk}><label for="${id}">${c[1]} (R${c[2]})</label></div>`;});});
  con.innerHTML=html;con.querySelectorAll(".card input").forEach(cb=>cb.onchange=()=>{found[cb.id]=cb.checked;saveState();updateUI();});
}
function initChart(){
  const ctx=document.getElementById("chartCanvas").getContext("2d");
  chart=new Chart(ctx,{type:"bar",data:{labels:["50%","75%","90%","99%"],datasets:[{label:"Giorni stimati",data:[0,0,0,0],backgroundColor:"rgba(25,118,210,0.7)"}]},options:{responsive:true,scales:{y:{beginAtZero:true}},plugins:{legend:{display:false}}}});
}
function updateUI(){
  const packs=+document.getElementById("packs").value||3,total=cards.length,foundCount=Object.values(found).filter(v=>v).length;
  const solMiss=cards.filter((c,i)=>c[0]==="Solgaleo"&&!found[`Solgaleo_${cards.filter(cc=>cc[0]==="Solgaleo").indexOf(c)}`]).length;
  const lunMiss=cards.filter((c,i)=>c[0]==="Lunala"&&!found[`Lunala_${cards.filter(cc=>cc[0]==="Lunala").indexOf(c)}`]).length;
  document.getElementById("counts").innerText=`Trovate: ${foundCount}/${total} · Mancanti S: ${solMiss} · L: ${lunMiss}`;
  document.getElementById("pattern").innerText=lunMiss>0?"Pattern: 2L + 1S":"Pattern: solo Solgaleo";
  document.getElementById("progressBar").style.width=(foundCount/total*100)+"%";
  const [m50,m75,m90,m99]=monteCarlo(solMiss,lunMiss,packs);
  document.getElementById("simStats").innerHTML=`<b>${m50} - ${m75} - ${m90} - ${m99}</b> giorni (50-75-90-99%)`;
  chart.data.datasets[0].data=[m50,m75,m90,m99];chart.update();
}
document.getElementById("packs").onchange=updateUI;
document.getElementById("resetBtn").onclick=()=>{if(confirm("Azzera tutte le carte trovate?")){found={};saveState();renderList();updateUI();}};
document.addEventListener("DOMContentLoaded",()=>{initChart();renderList();updateUI();});
</script>
</body>
</html>
